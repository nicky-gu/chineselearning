<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŸ å¿«ä¹å­¦æ±‰å­— ğŸŒŸ</title>
    <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.18.2/dist/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: bounceIn 0.8s ease;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        header h1 {
            font-size: 2.5em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.6s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .input-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            text-align: center;
        }

        #charInput {
            width: 100%;
            padding: 18px;
            font-size: 1.3em;
            border: 3px solid #ddd;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        #charInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .section-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95em;
            font-weight: bold;
            color: #666;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-btn:hover {
            transform: scale(1.05);
        }

        .practice-section {
            display: none;
        }

        .practice-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title h2 {
            color: #667eea;
            font-size: 1.5em;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: scale(1.05);
        }

        /* æ‹¼éŸ³å­¦ä¹ æ ·å¼ */
        .pinyin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }

        .pinyin-card {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-radius: 15px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .pinyin-card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .pinyin-card .text {
            font-size: 2.5em;
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 8px;
        }

        .pinyin-card .pinyin-hint {
            font-size: 1.3em;
            color: #636e72;
        }

        /* ç»ƒä¹ æœ¬æ ·å¼ */
        .practice-book {
            background: #fff9e6;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .practice-char {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .practice-char .big-char {
            font-size: 2.5em;
            width: 70px;
            text-align: center;
            margin-right: 15px;
            color: #667eea;
        }

        .practice-char .pinyin-display {
            font-size: 1.3em;
            color: #636e72;
            margin-right: 15px;
            min-width: 90px;
        }

        .practice-char .practice-input {
            flex: 1;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .practice-char .practice-input input {
            padding: 8px 12px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 10px;
            min-width: 100px;
        }

        .practice-char .practice-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        .practice-char .practice-input input.correct {
            border-color: #11998e;
            background: #d4edda;
        }

        .practice-char .practice-input input.wrong {
            border-color: #eb3349;
            background: #f8d7da;
        }

        .practice-char .play-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .practice-char .play-btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .practice-instruction {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            color: #1976d2;
            font-size: 0.95em;
        }

        /* ç»Ÿè®¡æ ·å¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 1em;
            color: #636e72;
        }

        .mistake-list {
            margin-top: 20px;
        }

        .mistake-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #fff5f5;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #eb3349;
        }

        .mistake-item .char {
            font-size: 1.5em;
            color: #2d3436;
            font-weight: bold;
        }

        .mistake-item .info {
            font-size: 0.9em;
            color: #666;
            margin-left: 10px;
        }

        .mistake-item .remove-btn {
            background: #eb3349;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .mistake-item .remove-btn:hover {
            transform: scale(1.05);
        }

        /* å¬éŸ³é€‰å­—æ ·å¼ */
        .sound-game {
            text-align: center;
        }

        .game-progress {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            font-size: 1.2em;
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }

        .sound-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 2.5em;
            cursor: pointer;
            margin: 15px auto;
            display: block;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .sound-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        .sound-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .option-btn {
            padding: 25px;
            font-size: 2em;
            border: 3px solid #ddd;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-btn:hover:not(:disabled) {
            border-color: #667eea;
            background: #f8f9ff;
            transform: scale(1.02);
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .option-btn.correct {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border-color: #11998e;
            animation: pulse 0.5s ease;
        }

        .option-btn.wrong {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
            border-color: #eb3349;
            animation: shake 0.5s ease;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* ç»“æœæ˜¾ç¤º */
        .result-box {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            margin-top: 20px;
        }

        .result-box .score {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .result-box .message {
            font-size: 1.5em;
            color: #2d3436;
            margin-bottom: 20px;
        }

        .result-box .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: scale(1.05);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state .emoji {
            font-size: 3em;
            margin-bottom: 15px;
        }

        footer {
            text-align: center;
            color: white;
            margin-top: 20px;
            opacity: 0.8;
            font-size: 0.9em;
        }

        /* ç™»å½•æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .modal h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
        }

        .modal p {
            color: #666;
            margin-bottom: 15px;
            text-align: center;
            font-size: 0.95em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #666;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input::-webkit-outer-spin-button,
        .form-group input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .form-group input[type=number] {
            -moz-appearance: textfield;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: scale(1.05);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .error-message {
            color: #eb3349;
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .success-message {
            color: #11998e;
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* åŒæ­¥æŒ‰é’®æ ·å¼ */
        .sync-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .sync-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 0.95em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sync-btn:hover {
            transform: scale(1.05);
        }

        .sync-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .sync-status {
            font-size: 0.9em;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sync-status.synced {
            color: #11998e;
        }

        .sync-status.syncing {
            color: #667eea;
        }

        .sync-status.error {
            color: #eb3349;
        }

        .sync-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .sync-status.synced .sync-status-dot {
            background: #11998e;
        }

        .sync-status.syncing .sync-status-dot {
            background: #667eea;
            animation: pulse 1s infinite;
        }

        .sync-status.error .sync-status-dot {
            background: #eb3349;
        }

        .user-info {
            text-align: center;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }

        .user-info .username {
            font-weight: bold;
            color: #667eea;
        }

        .logout-link {
            color: #eb3349;
            cursor: pointer;
            text-decoration: underline;
        }

        .logout-link:hover {
            color: #c0392b;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .pinyin-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .practice-char {
                flex-direction: column;
                align-items: flex-start;
            }

            .practice-char .big-char,
            .practice-char .pinyin-display {
                margin-right: 0;
                margin-bottom: 8px;
            }

            .section-tabs {
                gap: 5px;
            }

            .tab-btn {
                padding: 8px 15px;
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸŒŸ å¿«ä¹å­¦æ±‰å­— ğŸŒŸ</h1>
            <p>è¾“å…¥å­—æˆ–è¯ç»„ï¼Œç”¨ç©ºæ ¼æˆ–é€—å·åˆ†éš”ï¼Œå¼€å§‹ç»ƒä¹ å§ï¼</p>
            <div id="userInfoSection" style="display: none;">
                <div class="user-info">
                    <span>ä½ å¥½ï¼Œ<span class="username" id="displayUsername"></span>ï¼</span>
                    <span class="logout-link" onclick="handleLogout()">é€€å‡ºç™»å½•</span>
                </div>
                <div class="sync-section">
                    <div class="sync-status" id="syncStatus">
                        <div class="sync-status-dot"></div>
                        <span id="syncStatusText">æœªåŒæ­¥</span>
                    </div>
                    <button class="sync-btn" onclick="manualSync()" id="syncBtn">
                        <span>ğŸ”„</span>
                        <span>åŒæ­¥æ•°æ®</span>
                    </button>
                </div>
            </div>
            <div id="loginPrompt" style="text-align: center; margin-top: 15px;">
                <button class="btn-primary" onclick="openLoginModal()" style="padding: 10px 25px; border: none; border-radius: 20px; font-size: 1em; font-weight: bold; cursor: pointer; background: rgba(255,255,255,0.2); color: white; transition: all 0.3s ease;">
                    ğŸ” ç™»å½•åŒæ­¥æ•°æ®
                </button>
            </div>
        </header>

        <div class="card input-section">
            <h2>âœï¸ è¾“å…¥æ±‰å­—</h2>
            <input type="text" id="charInput" placeholder="è¾“å…¥å­—æˆ–è¯ç»„ï¼Œç”¨ç©ºæ ¼æˆ–é€—å·åˆ†éš”ï¼Œæ¯”å¦‚ï¼šå±±æ°´ å¤©ç©º é¸Ÿå„¿" maxlength="100">
            <div class="section-tabs">
                <button class="tab-btn active" data-tab="pinyin">ğŸ”Š æ‹¼éŸ³å­¦ä¹ </button>
                <button class="tab-btn" data-tab="practice">ğŸ“ ç»ƒä¹ æœ¬</button>
                <button class="tab-btn" data-tab="sound">ğŸ‘‚ å¬éŸ³é€‰å­—</button>
                <button class="tab-btn" data-tab="mistakes">âŒ é”™å­—é›†</button>
                <button class="tab-btn" data-tab="stats">ğŸ“Š ç»Ÿè®¡</button>
            </div>
        </div>

        <!-- æ‹¼éŸ³å­¦ä¹  -->
        <div class="card practice-section active" id="pinyin-section">
            <div class="section-title">
                <h2>ğŸ”Š æ‹¼éŸ³å­¦ä¹ </h2>
            </div>
            <p style="color: #666; margin-bottom: 15px;">ç‚¹å‡»å¡ç‰‡å¬å‘éŸ³ï¼ŒæŸ¥çœ‹æ‹¼éŸ³</p>
            <div id="pinyin-content">
                <div class="empty-state">
                    <div class="emoji">ğŸ“</div>
                    <p>è¯·å…ˆè¾“å…¥å­—æˆ–è¯ç»„</p>
                </div>
            </div>
        </div>

        <!-- ç»ƒä¹ æœ¬ -->
        <div class="card practice-section" id="practice-section">
            <div class="section-title">
                <h2>ğŸ“ ç»ƒä¹ æœ¬</h2>
            </div>
            <div id="practice-content">
                <div class="empty-state">
                    <div class="emoji">ğŸ“–</div>
                    <p>è¯·å…ˆè¾“å…¥å­—æˆ–è¯ç»„</p>
                </div>
            </div>
        </div>

        <!-- å¬éŸ³é€‰å­— -->
        <div class="card practice-section" id="sound-section">
            <div class="section-title">
                <h2>ğŸ‘‚ å¬éŸ³é€‰å­—</h2>
            </div>
            <div id="sound-content">
                <div class="empty-state">
                    <div class="emoji">ğŸ®</div>
                    <p>è¯·è‡³å°‘è¾“å…¥2ä¸ªå­—æˆ–è¯ç»„ï¼Œç„¶åå¼€å§‹æ¸¸æˆ</p>
                </div>
            </div>
        </div>

        <!-- é”™å­—é›† -->
        <div class="card practice-section" id="mistakes-section">
            <div class="section-title">
                <h2>âŒ é”™å­—é›†</h2>
                <button class="action-btn btn-danger" onclick="clearMistakes()">æ¸…ç©ºé”™å­—é›†</button>
            </div>
            <div id="mistakes-content">
                <div class="empty-state">
                    <div class="emoji">âœ¨</div>
                    <p>æš‚æ—¶æ²¡æœ‰é”™å­—ï¼Œç»§ç»­åŠ æ²¹ï¼</p>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡ -->
        <div class="card practice-section" id="stats-section">
            <div class="section-title">
                <h2>ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h2>
                <button class="action-btn btn-danger" onclick="clearStats()">æ¸…ç©ºæ•°æ®</button>
            </div>
            <p style="color: #666; margin-bottom: 15px;">ğŸ’¾ æ•°æ®è‡ªåŠ¨ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œä¸‹æ¬¡æ‰“å¼€è¿˜åœ¨</p>
            <div id="stats-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="totalLearned">0</div>
                        <div class="label">å·²å­¦å­—è¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="totalPractice">0</div>
                        <div class="label">ç»ƒä¹ æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="correctRate">0%</div>
                        <div class="label">æ­£ç¡®ç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="mistakeCount">0</div>
                        <div class="label">é”™å­—æ•°é‡</div>
                    </div>
                </div>
                <div id="learnedWordsList" style="margin-top: 20px;"></div>
            </div>
        </div>

        <footer>
            <p>ğŸ’– ç”¨å¿ƒé™ªä¼´å­©å­çš„æ¯ä¸€æ¬¡å­¦ä¹  ğŸ’–</p>
        </footer>

        <!-- ç™»å½•æ¨¡æ€æ¡† -->
        <div class="modal-overlay" id="loginModal">
            <div class="modal">
                <h2 id="modalTitle">ğŸ” ç™»å½• / æ³¨å†Œ</h2>
                <p>è¾“å…¥ä½ çš„åå­—å’Œ8ä½PINç æ¥åŒæ­¥å­¦ä¹ æ•°æ®</p>
                <div class="form-group">
                    <label for="usernameInput">ç”¨æˆ·å</label>
                    <input type="text" id="usernameInput" placeholder="è¾“å…¥ç”¨æˆ·å" maxlength="20" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="pinInput">8ä½PINç </label>
                    <input type="number" id="pinInput" placeholder="è¾“å…¥8ä½æ•°å­—" maxlength="8" min="0" max="99999999">
                </div>
                <div id="loginMessage"></div>
                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="closeLoginModal()">å–æ¶ˆ</button>
                    <button class="btn-primary" onclick="handleLogin()">ç™»å½• / æ³¨å†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨
        let currentChars = [];
        let mistakes = JSON.parse(localStorage.getItem('hanzi_mistakes') || '[]');
        let stats = JSON.parse(localStorage.getItem('hanzi_stats') || '{"totalLearned":0,"totalPractice":0,"correctCount":0}');

        // å¬éŸ³é€‰å­—æ¸¸æˆçŠ¶æ€
        let gameQueue = [];
        let currentQuestion = null;
        let gameScore = 0;
        let gameTotal = 0;
        let soundAnswered = false;

        // ========== äº‘åŒæ­¥ç›¸å…³ ==========
        let currentUser = null;  // { username: string, gistUrl: string, gistId: string }
        let currentPin = null;   // å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œç”¨äºåŠ å¯†è§£å¯†

        // åŠ å¯†/è§£å¯†å‡½æ•° (ä½¿ç”¨ AES)
        function encryptData(data, pin) {
            const jsonString = JSON.stringify(data);
            return CryptoJS.AES.encrypt(jsonString, pin).toString();
        }

        function decryptData(encryptedData, pin) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, pin);
                const decryptedString = bytes.toString(CryptoJS.enc.Utf8);
                if (!decryptedString) return null;
                return JSON.parse(decryptedString);
            } catch (e) {
                return null;
            }
        }

        // ç”Ÿæˆå”¯ä¸€çš„ç”¨æˆ·ID
        function generateUserId(username) {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 8);
            return `${username}_${timestamp}_${random}`;
        }

        // GitHub Gist API å‡½æ•°
        async function createGist(username, pin) {
            const userId = generateUserId(username);
            const data = {
                mistakes: mistakes,
                stats: stats,
                version: 1,
                createdAt: new Date().toISOString()
            };
            const encrypted = encryptData(data, pin);

            const gistData = {
                description: `å¿«ä¹å­¦æ±‰å­— - ${username} çš„å­¦ä¹ æ•°æ®`,
                public: false,
                files: {
                    'hanzi_learning_data.json': {
                        content: JSON.stringify({ encrypted: encrypted, userId: userId })
                    }
                }
            };

            const response = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // åŒ¿ååˆ›å»º Gistï¼Œä¸éœ€è¦ token
                },
                body: JSON.stringify(gistData)
            });

            if (!response.ok) {
                throw new Error('åˆ›å»º Gist å¤±è´¥');
            }

            const gist = await response.json();
            return {
                gistUrl: gist.html_url,
                gistId: gist.id,
                gistApiUrl: gist.url,
                userId: userId
            };
        }

        async function updateGist(gistApiUrl, pin) {
            const data = {
                mistakes: mistakes,
                stats: stats,
                version: 1,
                updatedAt: new Date().toISOString()
            };
            const encrypted = encryptData(data, pin);

            // è·å–ç°æœ‰ Gist å†…å®¹ä»¥ä¿æŒæ–‡ä»¶åå’Œç»“æ„
            const getResponse = await fetch(gistApiUrl);
            const existingGist = await getResponse.json();
            const fileName = Object.keys(existingGist.files)[0];
            const existingUserId = JSON.parse(existingGist.files[fileName].content).userId;

            const gistData = {
                files: {
                    [fileName]: {
                        content: JSON.stringify({ encrypted: encrypted, userId: existingUserId })
                    }
                }
            };

            const response = await fetch(gistApiUrl, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(gistData)
            });

            if (!response.ok) {
                throw new Error('æ›´æ–° Gist å¤±è´¥');
            }

            return await response.json();
        }

        async function getGist(gistId) {
            const response = await fetch(`https://api.github.com/gists/${gistId}`);
            if (!response.ok) {
                throw new Error('è·å– Gist å¤±è´¥');
            }
            return await response.json();
        }

        // ç™»å½•æ¨¡æ€æ¡†æ§åˆ¶
        function openLoginModal() {
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('loginMessage').innerHTML = '';
            document.getElementById('usernameInput').value = '';
            document.getElementById('pinInput').value = '';
            document.getElementById('usernameInput').focus();
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
        }

        // ç™»å½•/æ³¨å†Œå¤„ç†
        async function handleLogin() {
            const username = document.getElementById('usernameInput').value.trim();
            const pin = document.getElementById('pinInput').value.trim();
            const messageDiv = document.getElementById('loginMessage');

            // éªŒè¯è¾“å…¥
            if (!username) {
                messageDiv.innerHTML = '<div class="error-message">è¯·è¾“å…¥ç”¨æˆ·å</div>';
                return;
            }
            if (!/^\d{8}$/.test(pin)) {
                messageDiv.innerHTML = '<div class="error-message">è¯·è¾“å…¥8ä½æ•°å­—PINç </div>';
                return;
            }

            messageDiv.innerHTML = '<div class="success-message">æ­£åœ¨å¤„ç†...</div>';

            try {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç°æœ‰ç”¨æˆ·ï¼ˆä»æœ¬åœ°å­˜å‚¨æŸ¥æ‰¾ï¼‰
                const users = JSON.parse(localStorage.getItem('hanzi_cloud_users') || '{}');
                const existingUser = users[username];

                if (existingUser) {
                    // ç°æœ‰ç”¨æˆ· - å°è¯•ä» Gist è·å–æ•°æ®
                    const gist = await getGist(existingUser.gistId);
                    const fileName = Object.keys(gist.files)[0];
                    const content = JSON.parse(gist.files[fileName].content);

                    // ä½¿ç”¨ PIN è§£å¯†æ•°æ®
                    const decryptedData = decryptData(content.encrypted, pin);

                    if (!decryptedData) {
                        messageDiv.innerHTML = '<div class="error-message">PINç é”™è¯¯ï¼Œæ— æ³•è§£å¯†æ•°æ®</div>';
                        return;
                    }

                    // è§£å¯†æˆåŠŸï¼ŒåŠ è½½æ•°æ®
                    mistakes = decryptedData.mistakes || [];
                    stats = decryptedData.stats || { totalLearned: 0, totalPractice: 0, correctCount: 0 };

                    currentUser = existingUser;
                    currentPin = pin;

                    saveLocalData();
                    messageDiv.innerHTML = '<div class="success-message">ç™»å½•æˆåŠŸï¼æ•°æ®å·²åŒæ­¥</div>';
                } else {
                    // æ–°ç”¨æˆ· - åˆ›å»º Gist
                    const gistInfo = await createGist(username, pin);

                    currentUser = {
                        username: username,
                        gistUrl: gistInfo.gistUrl,
                        gistId: gistInfo.gistId,
                        gistApiUrl: gistInfo.gistApiUrl,
                        userId: gistInfo.userId
                    };
                    currentPin = pin;

                    users[username] = currentUser;
                    localStorage.setItem('hanzi_cloud_users', JSON.stringify(users));
                    saveLocalData();

                    messageDiv.innerHTML = '<div class="success-message">æ³¨å†ŒæˆåŠŸï¼å·²åˆ›å»ºäº‘ç«¯å¤‡ä»½</div>';
                }

                // æ›´æ–° UI
                updateLoginUI();

                setTimeout(() => {
                    closeLoginModal();
                    updateStatsSection();
                    updateMistakesSection();
                }, 1000);

            } catch (error) {
                console.error('Login error:', error);
                messageDiv.innerHTML = `<div class="error-message">ç™»å½•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é€€å‡ºç™»å½•
        function handleLogout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿæœ¬åœ°æ•°æ®å°†ä¿ç•™ï¼Œä½†ä¸ä¼šè‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ã€‚')) {
                currentUser = null;
                currentPin = null;
                updateLoginUI();
            }
        }

        // æ›´æ–°ç™»å½•ç›¸å…³çš„ UI
        function updateLoginUI() {
            const userInfoSection = document.getElementById('userInfoSection');
            const loginPrompt = document.getElementById('loginPrompt');

            if (currentUser) {
                userInfoSection.style.display = 'block';
                loginPrompt.style.display = 'none';
                document.getElementById('displayUsername').textContent = currentUser.username;
                updateSyncStatus('synced', 'å·²åŒæ­¥');
            } else {
                userInfoSection.style.display = 'none';
                loginPrompt.style.display = 'block';
            }
        }

        // æ›´æ–°åŒæ­¥çŠ¶æ€
        function updateSyncStatus(status, text) {
            const statusDiv = document.getElementById('syncStatus');
            const statusText = document.getElementById('syncStatusText');

            statusDiv.className = 'sync-status ' + status;
            statusText.textContent = text;
        }

        // æ‰‹åŠ¨åŒæ­¥
        async function manualSync() {
            if (!currentUser || !currentPin) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const syncBtn = document.getElementById('syncBtn');
            syncBtn.disabled = true;
            updateSyncStatus('syncing', 'æ­£åœ¨åŒæ­¥...');

            try {
                await updateGist(currentUser.gistApiUrl, currentPin);
                updateSyncStatus('synced', 'åŒæ­¥æˆåŠŸ: ' + new Date().toLocaleTimeString());
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('error', 'åŒæ­¥å¤±è´¥: ' + error.message);
            } finally {
                syncBtn.disabled = false;
            }
        }

        // è‡ªåŠ¨åŒæ­¥ï¼ˆåœ¨æ•°æ®å˜æ›´æ—¶è°ƒç”¨ï¼‰
        function autoSync() {
            if (currentUser && currentPin) {
                // å»¶è¿ŸåŒæ­¥ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
                if (window.syncTimeout) clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(() => {
                    updateGist(currentUser.gistApiUrl, currentPin)
                        .then(() => updateSyncStatus('synced', 'å·²è‡ªåŠ¨åŒæ­¥'))
                        .catch(err => console.log('Auto sync failed:', err));
                }, 3000);
            }
        }

        // ä¿å­˜æœ¬åœ°æ•°æ®
        function saveLocalData() {
            localStorage.setItem('hanzi_mistakes', JSON.stringify(mistakes));
            localStorage.setItem('hanzi_stats', JSON.stringify(stats));
        }

        // åˆå§‹åŒ–ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å·²ç™»å½•ç”¨æˆ·
        function initCloudSync() {
            const users = JSON.parse(localStorage.getItem('hanzi_cloud_users') || '{}');
            const lastUser = localStorage.getItem('hanzi_last_user');

            if (lastUser && users[lastUser]) {
                // æœ‰ä¸Šæ¬¡ç™»å½•çš„ç”¨æˆ·ï¼Œä½†éœ€è¦é‡æ–°è¾“å…¥ PIN
                // ä¸è‡ªåŠ¨ç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æŒ‰é’®
            }

            updateLoginUI();
        }

        // è¦†ç›–åŸæœ‰çš„ä¿å­˜å‡½æ•°ä»¥æ”¯æŒè‡ªåŠ¨åŒæ­¥
        const originalSaveMistakes = saveMistakes;
        const originalSaveStats = saveStats;

        function saveMistakes() {
            originalSaveMistakes();
            autoSync();
        }

        function saveStats() {
            originalSaveStats();
            autoSync();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initCloudSync();
        });

        // åˆå§‹åŒ–æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.practice-section').forEach(s => s.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + '-section').classList.add('active');

                // åˆ‡æ¢åˆ°é”™å­—é›†æˆ–ç»Ÿè®¡æ—¶åˆ·æ–°
                if (btn.dataset.tab === 'mistakes') updateMistakesSection();
                if (btn.dataset.tab === 'stats') updateStatsSection();
            });
        });

        // ç›‘å¬è¾“å…¥
        document.getElementById('charInput').addEventListener('input', (e) => {
            const input = e.target.value.replace(/[^\u4e00-\u9fa5\s,ï¼Œã€\n]/g, '');
            e.target.value = input;
            currentChars = [...new Set(input.split(/[\s,ï¼Œã€\n]+/).filter(s => s.trim()))];
            updateAllSections();
        });

        function updateAllSections() {
            updatePinyinSection();
            updatePracticeSection();
            updateSoundSection();
        }

        // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è½¬ä¹‰å­—ç¬¦ä¸²ç”¨äºJavaScript
        function escapeJs(text) {
            return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        function getPinyin(text) {
            try {
                return pinyinPro.pinyin(text, { toneType: 'symbol' });
            } catch (e) {
                return '?';
            }
        }

        // æ·»åŠ åˆ°å·²å­¦å­—è¯
        function addToLearned(texts) {
            texts.forEach(text => {
                if (!stats.learnedWords) stats.learnedWords = [];
                if (!stats.learnedWords.includes(text)) {
                    stats.learnedWords.push(text);
                    stats.totalLearned = stats.learnedWords.length;
                }
            });
            saveStats();
        }

        // æ·»åŠ åˆ°é”™å­—é›†
        function addToMistakes(text) {
            const existing = mistakes.find(m => typeof m === 'object' ? m.text === text : m === text);
            if (existing) {
                if (typeof existing === 'object') {
                    existing.count++;
                    existing.lastWrong = new Date().toISOString();
                } else {
                    // è½¬æ¢æ—§æ•°æ®æ ¼å¼
                    const idx = mistakes.indexOf(existing);
                    mistakes[idx] = { text: existing, count: 2, firstWrong: new Date().toISOString(), lastWrong: new Date().toISOString() };
                }
            } else {
                mistakes.push({ text: text, count: 1, firstWrong: new Date().toISOString(), lastWrong: new Date().toISOString() });
            }
            saveMistakes();
        }

        // ä»é”™å­—é›†ç§»é™¤
        function removeFromMistakes(text) {
            mistakes = mistakes.filter(m => m !== text);
            saveMistakes();
            updateMistakesSection();
            updateStatsSection();
        }

        function saveMistakes() {
            localStorage.setItem('hanzi_mistakes', JSON.stringify(mistakes));
        }

        function saveStats() {
            stats.lastPractice = new Date().toISOString();
            localStorage.setItem('hanzi_stats', JSON.stringify(stats));
        }

        function clearMistakes() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºé”™å­—é›†å—ï¼Ÿ')) {
                mistakes = [];
                saveMistakes();
                updateMistakesSection();
                updateStatsSection();
            }
        }

        function clearStats() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»Ÿè®¡æ•°æ®å—ï¼Ÿ')) {
                stats = { totalLearned: 0, totalPractice: 0, correctCount: 0, learnedWords: [] };
                saveStats();
                updateStatsSection();
            }
        }

        // æ›´æ–°æ‹¼éŸ³å­¦ä¹ åŒºåŸŸ
        function updatePinyinSection() {
            const container = document.getElementById('pinyin-content');
            if (currentChars.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">ğŸ“</div>
                        <p>è¯·å…ˆè¾“å…¥å­—æˆ–è¯ç»„</p>
                    </div>
                `;
                return;
            }

            addToLearned(currentChars);

            let html = '<div class="pinyin-grid">';
            currentChars.forEach(text => {
                const pinyin = getPinyin(text);
                html += `
                    <div class="pinyin-card" onclick="speakText('${text}')">
                        <div class="text">${text}</div>
                        <div class="pinyin-hint">${pinyin}</div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // æ›´æ–°ç»ƒä¹ æœ¬
        function updatePracticeSection() {
            const container = document.getElementById('practice-content');
            if (currentChars.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">ğŸ“–</div>
                        <p>è¯·å…ˆè¾“å…¥å­—æˆ–è¯ç»„</p>
                    </div>
                `;
                return;
            }

            addToLearned(currentChars);

            let html = `
                <div class="practice-instruction">
                    <strong>ç»ƒä¹ è¯´æ˜ï¼š</strong>å¬å‘éŸ³ï¼Œåœ¨è¾“å…¥æ¡†ä¸­å†™å‡ºå¯¹åº”çš„æ‹¼éŸ³ï¼ˆå¯ä¸ç”¨å£°è°ƒï¼‰
                </div>
                <div class="practice-book">
            `;

            currentChars.forEach((text, idx) => {
                const pinyin = getPinyin(text);
                const safeText = escapeHtml(text);
                const safePinyin = escapeHtml(pinyin);
                const jsText = escapeJs(text);
                const jsPinyin = escapeJs(pinyin);
                html += `
                    <div class="practice-char" data-text="${jsText}" data-pinyin="${jsPinyin}">
                        <div class="big-char">${safeText}</div>
                        <div class="pinyin-display">${safePinyin}</div>
                        <div class="practice-input">
                            <input type="text" class="pinyin-input" placeholder="è¾“å…¥æ‹¼éŸ³" oninput="checkPinyin(this, '${jsPinyin}', '${jsText}')">
                            <button class="play-btn" onclick="speakText('${jsText}')">ğŸ”Š</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // æ£€æŸ¥æ‹¼éŸ³
        function checkPinyin(input, correctPinyin, text) {
            const cleanInput = input.value.toLowerCase()
                .replace(/[ÄÃ¡ÇÃ ]/g, 'a').replace(/[Ä“Ã©Ä›Ã¨]/g, 'e')
                .replace(/[Ä«Ã­ÇÃ¬]/g, 'i').replace(/[ÅÃ³Ç’Ã²]/g, 'o')
                .replace(/[Å«ÃºÇ”Ã¹]/g, 'u').replace(/[Ç–Ç˜ÇšÇœÃ¼]/g, 'v')
                .replace(/\d/g, '').replace(/\s/g, '');

            const cleanCorrect = correctPinyin.toLowerCase()
                .replace(/[ÄÃ¡ÇÃ ]/g, 'a').replace(/[Ä“Ã©Ä›Ã¨]/g, 'e')
                .replace(/[Ä«Ã­ÇÃ¬]/g, 'i').replace(/[ÅÃ³Ç’Ã²]/g, 'o')
                .replace(/[Å«ÃºÇ”Ã¹]/g, 'u').replace(/[Ç–Ç˜ÇšÇœÃ¼]/g, 'v')
                .replace(/\d/g, '').replace(/\s/g, '');

            stats.totalPractice++;

            if (cleanInput === cleanCorrect && cleanInput.length > 0) {
                input.classList.remove('wrong');
                input.classList.add('correct');
                stats.correctCount++;
                // å¦‚æœä¹‹å‰åœ¨é”™å­—é›†ï¼Œç­”å¯¹3æ¬¡åç§»é™¤
                const mistakeIndex = mistakes.indexOf(text);
                if (mistakeIndex !== -1) {
                    const count = parseInt(input.dataset.correctCount || 0) + 1;
                    input.dataset.correctCount = count;
                    if (count >= 3) {
                        removeFromMistakes(text);
                        input.dataset.correctCount = 0;
                    }
                }
            } else if (input.value.length > 0) {
                input.classList.remove('correct');
                input.classList.add('wrong');
                addToMistakes(text);
            } else {
                input.classList.remove('correct', 'wrong');
                stats.totalPractice--;
            }

            saveStats();
        }

        // æ›´æ–°å¬éŸ³é€‰å­—
        function updateSoundSection() {
            const container = document.getElementById('sound-content');
            const charsToUse = currentChars.length >= 2 ? currentChars : mistakes.map(m => typeof m === 'object' ? m.text : m);

            if (charsToUse.length < 2) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">ğŸ®</div>
                        <p>è¯·è‡³å°‘è¾“å…¥2ä¸ªå­—æˆ–è¯ç»„ï¼Œæˆ–ä½¿ç”¨é”™å­—é›†ç»ƒä¹ </p>
                    </div>
                `;
                return;
            }

            // åˆ›å»ºæ¸¸æˆé˜Ÿåˆ—ï¼Œæ¯ä¸ªå­—/è¯ç»„éƒ½ä¼šè¢«é—®åˆ°
            gameQueue = [...charsToUse].sort(() => Math.random() - 0.5);
            gameScore = 0;
            gameTotal = gameQueue.length;

            startGame();
        }

        function startGame() {
            const container = document.getElementById('sound-content');

            if (gameQueue.length === 0) {
                // æ¸¸æˆç»“æŸ
                const rate = gameTotal > 0 ? Math.round((gameScore / gameTotal) * 100) : 0;
                container.innerHTML = `
                    <div class="result-box">
                        <div class="score">${rate}%</div>
                        <div class="message">ç­”å¯¹ ${gameScore} / ${gameTotal} é¢˜</div>
                        <button class="btn btn-primary" onclick="updateSoundSection()">ğŸ”„ å†æ¥ä¸€å±€</button>
                        ${mistakes.length > 0 ? '<button class="btn btn-primary" onclick="practiceMistakes()">ğŸ“ ç»ƒä¹ é”™å­—</button>' : ''}
                    </div>
                `;
                return;
            }

            currentQuestion = gameQueue.pop();
            const allOptions = [...currentChars.length >= 2 ? currentChars : mistakes.map(m => typeof m === 'object' ? m.text : m)];

            // ç”Ÿæˆé€‰é¡¹
            let options = [currentQuestion];
            while (options.length < 4 && options.length < allOptions.length) {
                const randomOption = allOptions[Math.floor(Math.random() * allOptions.length)];
                if (!options.includes(randomOption)) {
                    options.push(randomOption);
                }
            }
            options = options.sort(() => Math.random() - 0.5);

            const progress = ((gameTotal - gameQueue.length) / gameTotal * 100).toFixed(0);

            container.innerHTML = `
                <div class="game-progress">
                    <span>è¿›åº¦: ${gameTotal - gameQueue.length} / ${gameTotal}</span>
                    <span>å¾—åˆ†: ${gameScore}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="sound-game">
                    <button class="sound-btn" id="soundBtn" onclick="playSound()">ğŸ”Š</button>
                    <div class="options-grid" id="soundOptions">
                        ${options.map((opt, idx) => `<button class="option-btn" data-idx="${idx}" onclick="handleOptionClick(${idx})">${escapeHtml(opt)}</button>`).join('')}
                    </div>
                </div>
            `;

            // ä¿å­˜é€‰é¡¹åˆ°æ•°ç»„
            window.currentOptions = options;
            soundAnswered = false;
            // è‡ªåŠ¨æ’­æ”¾
            setTimeout(() => playSound(), 300);
        }

        function handleOptionClick(idx) {
            if (window.currentOptions && window.currentOptions[idx] !== undefined) {
                const btn = document.querySelector(`.option-btn[data-idx="${idx}"]`);
                checkAnswer(window.currentOptions[idx], btn);
            }
        }

        function playSound() {
            if (currentQuestion) {
                speakText(currentQuestion);
            }
        }

        function checkAnswer(answer, btn) {
            if (soundAnswered) return;
            soundAnswered = true;

            const allBtns = document.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.disabled = true);
            document.getElementById('soundBtn').disabled = true;

            stats.totalPractice++;

            if (answer === currentQuestion) {
                btn.classList.add('correct');
                gameScore++;
                stats.correctCount++;
                speakText('ç­”å¯¹äº†ï¼');
            } else {
                btn.classList.add('wrong');
                allBtns.forEach(b => {
                    if (b.textContent === currentQuestion) {
                        b.classList.add('correct');
                    }
                });
                addToMistakes(currentQuestion);
                speakText('å†è¯•è¯•å§');
            }

            saveStats();

            // 1.5ç§’åä¸‹ä¸€é¢˜
            setTimeout(() => startGame(), 1500);
        }

        function practiceMistakes() {
            currentChars = mistakes.map(m => typeof m === 'object' ? m.text : m);
            document.getElementById('charInput').value = currentChars.join(' ');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.practice-section').forEach(s => s.classList.remove('active'));
            document.querySelector('[data-tab="sound"]').classList.add('active');
            document.getElementById('sound-section').classList.add('active');
            updateSoundSection();
        }

        // æ›´æ–°é”™å­—é›†
        function updateMistakesSection() {
            const container = document.getElementById('mistakes-content');

            if (mistakes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">âœ¨</div>
                        <p>æš‚æ—¶æ²¡æœ‰é”™å­—ï¼Œç»§ç»­åŠ æ²¹ï¼</p>
                    </div>
                `;
                return;
            }

            // æŒ‰é”™è¯¯æ¬¡æ•°æ’åº
            const sortedMistakes = [...mistakes].sort((a, b) => {
                const countA = typeof a === 'object' ? a.count : 1;
                const countB = typeof b === 'object' ? b.count : 1;
                return countB - countA;
            });

            let html = '<div class="mistake-list">';
            sortedMistakes.forEach((item, idx) => {
                const text = typeof item === 'object' ? item.text : item;
                const count = typeof item === 'object' ? item.count : 1;
                const lastWrong = typeof item === 'object' && item.lastWrong ? new Date(item.lastWrong).toLocaleString('zh-CN') : '';
                const pinyin = getPinyin(text);

                // æ‰¾åˆ°åŸå§‹ç´¢å¼•ç”¨äºåˆ é™¤
                const originalIdx = mistakes.indexOf(item);

                html += `
                    <div class="mistake-item">
                        <div style="flex: 1;">
                            <span class="char">${escapeHtml(text)}</span>
                            <span class="info">${escapeHtml(pinyin)}</span>
                            <span class="info" style="margin-left: 10px; color: #eb3349;">âŒ é”™è¯¯ ${count} æ¬¡</span>
                            ${lastWrong ? `<span class="info" style="margin-left: 10px; color: #999; font-size: 0.85em;">${lastWrong}</span>` : ''}
                        </div>
                        <button class="remove-btn" onclick="removeFromMistakes(${originalIdx})">ç§»é™¤</button>
                    </div>
                `;
            });
            html += '</div>';
            if (mistakes.length > 0) {
                const totalErrors = mistakes.reduce((sum, m) => sum + (typeof m === 'object' ? m.count : 1), 0);
                html += `<p style="text-align: center; color: #666; margin-top: 15px;">ç´¯è®¡é”™è¯¯ ${totalErrors} æ¬¡</p>`;
                html += `<button class="btn btn-primary" onclick="practiceMistakes()" style="margin-top: 15px; padding: 12px 30px; border: none; border-radius: 25px; font-size: 1em; font-weight: bold; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">ğŸ“ ç»ƒä¹ è¿™äº›é”™å­—</button>`;
            }
            container.innerHTML = html;
        }

        // ä¿®æ”¹ç§»é™¤å‡½æ•°ä½¿ç”¨ç´¢å¼•
        function removeFromMistakes(idx) {
            if (typeof idx === 'number') {
                mistakes.splice(idx, 1);
            } else {
                mistakes = mistakes.filter(m => m !== idx);
            }
            saveMistakes();
            updateMistakesSection();
            updateStatsSection();
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStatsSection() {
            document.getElementById('totalLearned').textContent = stats.totalLearned || 0;
            document.getElementById('totalPractice').textContent = stats.totalPractice || 0;
            const rate = stats.totalPractice > 0 ? Math.round((stats.correctCount / stats.totalPractice) * 100) : 0;
            document.getElementById('correctRate').textContent = rate + '%';
            document.getElementById('mistakeCount').textContent = mistakes.length;

            // æ˜¾ç¤ºå·²å­¦å­—è¯åˆ—è¡¨
            const listContainer = document.getElementById('learnedWordsList');
            if (stats.learnedWords && stats.learnedWords.length > 0) {
                const lastPractice = stats.lastPractice ? new Date(stats.lastPractice).toLocaleString('zh-CN') : 'æš‚æ— è®°å½•';
                let html = `
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 10px;">
                        <p style="color: #666; margin-bottom: 10px;">ğŸ• æœ€åç»ƒä¹ ï¼š${lastPractice}</p>
                    </div>
                    <div style="background: #fff9e6; padding: 15px; border-radius: 10px; margin-top: 10px;">
                        <h3 style="color: #667eea; margin-bottom: 10px; font-size: 1.1em;">ğŸ“š å·²å­¦å­—è¯åˆ—è¡¨</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                `;
                stats.learnedWords.slice().reverse().forEach(word => {
                    html += `<span style="background: white; padding: 6px 12px; border-radius: 15px; font-size: 0.95em; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">${escapeHtml(word)}</span>`;
                });
                html += `
                        </div>
                    </div>
                `;
                listContainer.innerHTML = html;
            } else {
                listContainer.innerHTML = `<p style="text-align: center; color: #999; padding: 20px;">è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•ï¼Œå¼€å§‹å­¦ä¹ å§ï¼</p>`;
            }
        }

        // è¯­éŸ³åŠŸèƒ½
        function speakText(text) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            }
        }

        // åˆå§‹åŒ–ç»Ÿè®¡æ˜¾ç¤º
        updateStatsSection();

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
        window.addEventListener('load', () => {
            if (stats.totalPractice > 0) {
                const lastTime = stats.lastPractice ? new Date(stats.lastPractice).toLocaleString('zh-CN') : '';
                setTimeout(() => {
                    speakText(`æ¬¢è¿å›æ¥ï¼ä½ å·²ç»ç»ƒä¹ äº†${stats.totalPractice}æ¬¡ï¼Œç»§ç»­åŠ æ²¹ï¼`);
                }, 500);
            }
        });
    </script>
</body>
</html>
